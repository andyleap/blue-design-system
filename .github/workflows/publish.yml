name: Publish to NPM

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Verify build quality
        run: |
          echo "Checking build outputs before publish..."
          test -f "dist/design-system.css" || exit 1
          test -f "dist/design-system.min.css" || exit 1
          test -f "tokens/bundle.css" || exit 1
          test -f "components/bundle.css" || exit 1
          test -f "themes/bundle.css" || exit 1
          
          # Check that minified version is smaller than main version
          MAIN_SIZE=$(wc -c < "dist/design-system.css")
          MIN_SIZE=$(wc -c < "dist/design-system.min.css")
          if [ "$MIN_SIZE" -ge "$MAIN_SIZE" ]; then
            echo "❌ Minified CSS is not smaller than main CSS"
            exit 1
          fi
          echo "✅ Build quality verified"
        
      - name: Run tests (if any)
        run: npm test --if-present
        
      - name: Update version (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
          
      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Create Git tag and push (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          NEW_VERSION=$(node -p "require('./package.json').version")
          git add package.json
          git commit -m "Release v${NEW_VERSION}"
          git tag "v${NEW_VERSION}"
          git push origin main --tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}